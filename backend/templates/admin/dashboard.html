{% extends "base.html" %}

{% block title %}Admin Dashboard - Citizen Developer Posting Board{% endblock %}

{% block content %}
<div class="page-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2 class="page-title" style="margin: 0;">Admin Dashboard</h2>
        <a href="{{ url_for('admin.logout') }}" class="btn btn-secondary">Logout</a>
    </div>
    
    <div class="admin-nav">
        <a href="{{ url_for('admin.dashboard') }}" class="admin-nav-link active">Dashboard</a>
        <a href="{{ url_for('admin.ideas') }}" class="admin-nav-link">Manage Ideas</a>
        <a href="{{ url_for('admin.skills') }}" class="admin-nav-link">Manage Skills</a>
        <a href="{{ url_for('admin.teams') }}" class="admin-nav-link">Manage Teams</a>
        <a href="{{ url_for('admin.users') }}" class="admin-nav-link">Manage Users</a>
        <a href="{{ url_for('admin.email_settings') }}" class="admin-nav-link">Email Settings</a>
        <a href="{{ url_for('admin.bulk_upload') }}" class="admin-nav-link">Bulk Upload</a>
    </div>
    
    <!-- Admin Notifications -->
    <div id="notifications-container" style="margin-bottom: 30px; display: none;">
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 20px;">
            <h3 style="margin: 0 0 15px 0; color: #856404; font-size: 1.1rem; font-weight: 600;">Pending Admin Actions</h3>
            <div id="notifications-list" style="display: flex; flex-direction: column; gap: 10px;"></div>
        </div>
    </div>
    
    <div id="stats-container" class="stats-grid">
        <div class="stat-card">
            <h3 id="total-ideas">-</h3>
            <p>Total Ideas</p>
        </div>
        <div class="stat-card">
            <h3 id="open-ideas">-</h3>
            <p>Open Ideas</p>
        </div>
        <div class="stat-card">
            <h3 id="claimed-ideas">-</h3>
            <p>Claimed Ideas</p>
        </div>
        <div class="stat-card">
            <h3 id="complete-ideas">-</h3>
            <p>Complete Ideas</p>
        </div>
        <div class="stat-card">
            <h3 id="total-skills">-</h3>
            <p>Total Skills</p>
        </div>
    </div>
    
    <div style="margin-top: 40px;">
        <h3>Manage Ideas</h3>
        <div id="ideas-table-container">
            <div class="loading">Loading ideas...</div>
        </div>
        <div id="pagination-container" style="margin-top: 20px; text-align: center;"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
.notification-badge {
    background: #dc3545;
    color: white;
    border-radius: 10px;
    padding: 2px 6px;
    font-size: 11px;
    font-weight: bold;
    margin-left: 5px;
    vertical-align: super;
}

.admin-nav-link {
    position: relative;
}
</style>
<script>
// Dashboard statistics loading
(function() {
    // Ensure DOM elements exist before accessing them
    function ensureElement(id) {
        const element = document.getElementById(id);
        if (!element) {
            console.error(`Element with id '${id}' not found`);
        }
        return element;
    }

    // Load admin dashboard notifications (renamed to avoid conflict with bell notifications)
    async function loadAdminDashboardNotifications() {
        try {
            const response = await fetch('/api/admin/notifications');
            const data = await response.json();
            
            if (data.success && data.notifications.length > 0) {
                const container = document.getElementById('notifications-container');
                const list = document.getElementById('notifications-list');
                
                // Clear existing notifications
                list.innerHTML = '';
                
                // Sort by priority (high first)
                const sortedNotifications = data.notifications.sort((a, b) => {
                    const priorityOrder = { 'high': 0, 'medium': 1, 'low': 2 };
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                });
                
                // Create notification items
                sortedNotifications.forEach(notification => {
                    const item = document.createElement('div');
                    item.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 6px; border: 1px solid #ffeaa7;';
                    
                    const message = document.createElement('div');
                    message.style.cssText = 'flex: 1; color: #856404; font-weight: 500;';
                    message.innerHTML = `<span style="color: #${notification.priority === 'high' ? 'dc3545' : '856404'};">‚óè</span> ${notification.message}`;
                    
                    const action = document.createElement('a');
                    action.href = notification.link;
                    action.className = 'btn btn-sm btn-primary';
                    action.textContent = 'Review';
                    action.style.marginLeft = '10px';
                    
                    item.appendChild(message);
                    item.appendChild(action);
                    list.appendChild(item);
                });
                
                // Show the container
                container.style.display = 'block';
            } else {
                // Hide the container if no notifications
                document.getElementById('notifications-container').style.display = 'none';
            }
        } catch (error) {
            console.error('Error loading notifications:', error);
        }
    }
    
    // Load dashboard statistics
    async function loadStats() {
        console.log('Loading stats... readyState:', document.readyState);
        
        // Double-check elements exist with retry logic
        let retries = 0;
        const maxRetries = 5;
        
        while (retries < maxRetries) {
            const elements = {
                totalIdeas: ensureElement('total-ideas'),
                openIdeas: ensureElement('open-ideas'),
                claimedIdeas: ensureElement('claimed-ideas'),
                completeIdeas: ensureElement('complete-ideas'),
                totalSkills: ensureElement('total-skills')
            };
            
            // Check if all elements exist
            const allElementsExist = Object.values(elements).every(el => el !== null);
            
            if (allElementsExist) {
                // All elements found, proceed with loading stats
                try {
                    const response = await fetch('/api/stats');
                    console.log('Response status:', response.status);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const stats = await response.json();
                    console.log('Stats data:', stats);
                    
                    // Update stat cards
                    elements.totalIdeas.textContent = stats.total_ideas || 0;
                    elements.openIdeas.textContent = stats.open_ideas || 0;
                    elements.claimedIdeas.textContent = stats.claimed_ideas || 0;
                    elements.completeIdeas.textContent = stats.complete_ideas || 0;
                    elements.totalSkills.textContent = stats.total_skills || 0;
                    
                    console.log('Stats loaded successfully');
                    return; // Success, exit the function
                    
                } catch (error) {
                    console.error('Error loading statistics:', error);
                    // Show error in UI
                    if (elements.totalIdeas) elements.totalIdeas.textContent = 'Error';
                    if (elements.openIdeas) elements.openIdeas.textContent = 'Error';
                    if (elements.claimedIdeas) elements.claimedIdeas.textContent = 'Error';
                    if (elements.completeIdeas) elements.completeIdeas.textContent = 'Error';
                    if (elements.totalSkills) elements.totalSkills.textContent = 'Error';
                    return; // Error occurred, exit
                }
            }
            
            // Elements not found, retry after a delay
            retries++;
            console.log(`Elements not found, retry ${retries}/${maxRetries}`);
            await new Promise(resolve => setTimeout(resolve, 200));
        }
        
        console.error('Failed to find all required DOM elements after retries');
    }

    // Initialize stats loading with multiple strategies
    function initStats() {
        // Strategy 1: If page is already complete, wait a bit then load
        if (document.readyState === 'complete') {
            console.log('Page already complete, loading stats after delay');
            setTimeout(() => {
                loadStats();
                loadAdminDashboardNotifications();
            }, 250);
        }
        
        // Strategy 2: Wait for window load event (includes all resources)
        window.addEventListener('load', function() {
            console.log('Window load event fired');
            setTimeout(() => {
                loadStats();
                loadAdminDashboardNotifications();
            }, 250);
        });
        
        // Strategy 3: Use requestAnimationFrame to ensure rendering is complete
        if (typeof requestAnimationFrame !== 'undefined') {
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    console.log('RequestAnimationFrame triggered');
                    loadStats();
                    loadAdminDashboardNotifications();
                });
            });
        }
    }

    // Start initialization based on document state
    if (document.readyState === 'loading') {
        console.log('Document still loading, waiting for DOMContentLoaded');
        document.addEventListener('DOMContentLoaded', initStats);
    } else {
        console.log('Document already loaded, initializing directly');
        initStats();
    }
    
    // Refresh dashboard notifications periodically (every 30 seconds)
    setInterval(() => {
        loadAdminDashboardNotifications();
    }, 30000);
})();

// Ideas management functionality
let currentPage = 1;
const itemsPerPage = 20;
let allIdeas = [];

async function loadIdeas() {
    try {
        // Explicitly request all ideas without status filter
        const ideas = await utils.fetchJson('/api/ideas?status=');
        allIdeas = ideas;
        displayIdeas();
    } catch (error) {
        console.error('Error loading ideas:', error);
        document.getElementById('ideas-table-container').innerHTML = '<div class="error">Error loading ideas</div>';
    }
}

function displayIdeas() {
    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const pageIdeas = allIdeas.slice(start, end);
    
    if (pageIdeas.length === 0) {
        document.getElementById('ideas-table-container').innerHTML = '<div class="empty-state">No ideas found</div>';
        return;
    }
    
    let tableHtml = `
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Team</th>
                    <th>Priority</th>
                    <th>Size</th>
                    <th>Status</th>
                    <th>Submitted By</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    pageIdeas.forEach(idea => {
        const statusClass = `status-${idea.status}`;
        tableHtml += `
            <tr data-idea-id="${idea.id}">
                <td>${idea.id}</td>
                <td class="editable-cell" data-field="title">${utils.escapeHtml(idea.title)}</td>
                <td class="editable-cell" data-field="team">${utils.escapeHtml(idea.benefactor_team)}</td>
                <td class="editable-cell" data-field="priority">
                    <select class="cell-select" data-field="priority">
                        <option value="low" ${idea.priority === 'low' ? 'selected' : ''}>Low</option>
                        <option value="medium" ${idea.priority === 'medium' ? 'selected' : ''}>Medium</option>
                        <option value="high" ${idea.priority === 'high' ? 'selected' : ''}>High</option>
                    </select>
                </td>
                <td class="editable-cell" data-field="size">
                    <select class="cell-select" data-field="size">
                        <option value="small" ${idea.size === 'small' ? 'selected' : ''}>Small</option>
                        <option value="medium" ${idea.size === 'medium' ? 'selected' : ''}>Medium</option>
                        <option value="large" ${idea.size === 'large' ? 'selected' : ''}>Large</option>
                        <option value="extra_large" ${idea.size === 'extra_large' ? 'selected' : ''}>Extra Large</option>
                    </select>
                </td>
                <td class="editable-cell" data-field="status">
                    <select class="cell-select ${statusClass}" data-field="status">
                        <option value="open" ${idea.status === 'open' ? 'selected' : ''}>Open</option>
                        <option value="claimed" ${idea.status === 'claimed' ? 'selected' : ''}>Claimed</option>
                        <option value="complete" ${idea.status === 'complete' ? 'selected' : ''}>Complete</option>
                    </select>
                </td>
                <td>${idea.submitter_name ? utils.escapeHtml(idea.submitter_name) + ' (' + utils.escapeHtml(idea.email) + ')' : utils.escapeHtml(idea.email)}</td>
                <td>${utils.formatDate(idea.date_submitted)}</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="deleteIdea(${idea.id})">Delete</button>
                </td>
            </tr>
        `;
    });
    
    tableHtml += '</tbody></table>';
    document.getElementById('ideas-table-container').innerHTML = tableHtml;
    
    // Add event listeners for editable cells
    setupEditableCells();
    
    // Update pagination
    updatePagination();
}

function setupEditableCells() {
    // Text fields
    document.querySelectorAll('.editable-cell[data-field]:not(:has(select))').forEach(cell => {
        cell.addEventListener('click', function() {
            if (this.querySelector('input')) return;
            
            const originalValue = this.textContent;
            const field = this.dataset.field;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value = originalValue;
            input.className = 'cell-input';
            
            this.innerHTML = '';
            this.appendChild(input);
            input.focus();
            input.select();
            
            const saveValue = async () => {
                const newValue = input.value.trim();
                if (newValue !== originalValue) {
                    const ideaId = this.closest('tr').dataset.ideaId;
                    await updateIdea(ideaId, field, newValue);
                }
                this.textContent = newValue || originalValue;
            };
            
            input.addEventListener('blur', saveValue);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    input.blur();
                }
            });
        });
    });
    
    // Select fields
    document.querySelectorAll('.cell-select').forEach(select => {
        select.addEventListener('change', async function() {
            const ideaId = this.closest('tr').dataset.ideaId;
            const field = this.dataset.field;
            const value = this.value;
            
            if (field === 'status') {
                this.className = `cell-select status-${value}`;
            }
            
            await updateIdea(ideaId, field, value);
        });
    });
}

async function updateIdea(ideaId, field, value) {
    try {
        const data = {};
        data[field] = value;
        
        await utils.fetchJson(`/api/ideas/${ideaId}`, {
            method: 'PUT',
            body: JSON.stringify(data)
        });
    } catch (error) {
        console.error('Error updating idea:', error);
        alert('Error updating idea. Please refresh and try again.');
    }
}

async function deleteIdea(ideaId) {
    if (!confirm('Are you sure you want to delete this idea?')) return;
    
    try {
        await utils.fetchJson(`/api/ideas/${ideaId}`, {
            method: 'DELETE'
        });
        loadIdeas();
    } catch (error) {
        console.error('Error deleting idea:', error);
        alert('Error deleting idea. Please try again.');
    }
}

function updatePagination() {
    const totalPages = Math.ceil(allIdeas.length / itemsPerPage);
    let paginationHtml = '';
    
    if (totalPages > 1) {
        if (currentPage > 1) {
            paginationHtml += `<button class="btn btn-secondary btn-sm" onclick="changePage(${currentPage - 1})">Previous</button> `;
        }
        
        paginationHtml += `<span>Page ${currentPage} of ${totalPages}</span> `;
        
        if (currentPage < totalPages) {
            paginationHtml += `<button class="btn btn-secondary btn-sm" onclick="changePage(${currentPage + 1})">Next</button>`;
        }
    }
    
    document.getElementById('pagination-container').innerHTML = paginationHtml;
}

function changePage(page) {
    currentPage = page;
    displayIdeas();
}

// Initialize ideas loading
loadIdeas();

// Auto-refresh every 5 seconds
setInterval(loadIdeas, 5000);
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}My Ideas - Citizen Developer Posting Board{% endblock %}

{% block content %}
<div class="page-container">
    <h2 class="page-title">My Ideas</h2>
    
    <!-- Email lookup section (hidden by default) -->
    <div id="email-lookup-section" style="display: none; margin-bottom: 30px; text-align: center;">
        <p>Or lookup your ideas by email:</p>
        <div style="display: flex; justify-content: center; gap: 10px; max-width: 500px; margin: 0 auto;">
            <input type="email" id="email-lookup" placeholder="Enter your email address" style="flex: 1; padding: 8px;">
            <button id="lookup-btn" class="btn btn-primary">Lookup Ideas</button>
        </div>
        <div id="lookup-error" style="color: red; margin-top: 10px; display: none;"></div>
    </div>
    
    <div id="stats-container" class="stats-grid" style="margin-bottom: 30px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
        <div class="stat-card">
            <h3 id="submitted-count">0</h3>
            <p>Submitted</p>
        </div>
        <div class="stat-card">
            <h3 id="claimed-by-me-count">0</h3>
            <p>Claimed by Me</p>
        </div>
        <div class="stat-card">
            <h3 id="open-count">0</h3>
            <p>Open</p>
        </div>
        <div class="stat-card">
            <h3 id="complete-count">0</h3>
            <p>Complete</p>
        </div>
    </div>
    
    <div id="my-ideas-container" class="ideas-grid">
        <div class="loading">Loading your ideas...</div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.relationship-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 4px;
    color: white;
    font-size: 12px;
    font-weight: bold;
    margin-top: 5px;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    // Elements
    const ideasContainer = document.getElementById('my-ideas-container');
    const submittedCount = document.getElementById('submitted-count');
    const claimedByMeCount = document.getElementById('claimed-by-me-count');
    const openCount = document.getElementById('open-count');
    const completeCount = document.getElementById('complete-count');
    const emailLookupSection = document.getElementById('email-lookup-section');
    const emailInput = document.getElementById('email-lookup');
    const lookupBtn = document.getElementById('lookup-btn');
    const lookupError = document.getElementById('lookup-error');
    
    // Track current email for auto-refresh
    let currentEmail = null;
    
    // Load user's ideas
    async function loadMyIdeas(email = null) {
        try {
            let url = '/api/my-ideas';
            if (email) {
                url += `?email=${encodeURIComponent(email)}`;
            }
            const response = await utils.fetchJson(url);
            
            // Check if response is an object with user_ideas and team_ideas
            const isManagerResponse = response && typeof response === 'object' && 'user_ideas' in response;
            const ideas = isManagerResponse ? response.user_ideas : response;
            const teamIdeas = isManagerResponse ? response.team_ideas : [];
            const managedTeam = isManagerResponse ? response.managed_team : null;
            const pendingClaims = isManagerResponse ? response.pending_claims : [];
            const pendingApprovals = isManagerResponse ? response.pending_approvals : [];
            
            if (ideas.length === 0 && !email) {
                // Show email lookup option when no session ideas found
                emailLookupSection.style.display = 'block';
                ideasContainer.innerHTML = `
                    <div class="empty-state">
                        <h3>No ideas found in your current session</h3>
                        <p><a href="/submit" class="btn btn-primary">Submit your first idea</a></p>
                    </div>
                `;
                submittedCount.textContent = '0';
                claimedByMeCount.textContent = '0';
                openCount.textContent = '0';
                completeCount.textContent = '0';
                return;
            } else if (ideas.length === 0 && email) {
                // No ideas found for this email
                ideasContainer.innerHTML = `
                    <div class="empty-state">
                        <h3>No ideas found for email: ${utils.escapeHtml(email)}</h3>
                        <p><a href="/submit" class="btn btn-primary">Submit your first idea</a></p>
                    </div>
                `;
                submittedCount.textContent = '0';
                claimedByMeCount.textContent = '0';
                openCount.textContent = '0';
                completeCount.textContent = '0';
                return;
            }
            
            // Hide email lookup section when ideas are found
            if (ideas.length > 0) {
                emailLookupSection.style.display = 'none';
                currentEmail = email; // Track current email for auto-refresh
            }
            
            // Calculate stats
            const stats = {
                submitted: 0,
                claimedByMe: 0,
                open: 0,
                complete: 0
            };
            
            ideas.forEach(idea => {
                // Count by relationship
                if (idea.relationship === 'submitted' || idea.relationship === 'both') {
                    stats.submitted++;
                }
                if (idea.relationship === 'claimed' || idea.relationship === 'both') {
                    stats.claimedByMe++;
                }
                
                // Count by status
                if (idea.status === 'open') {
                    stats.open++;
                } else if (idea.status === 'complete') {
                    stats.complete++;
                }
            });
            
            // Update stats
            submittedCount.textContent = stats.submitted;
            claimedByMeCount.textContent = stats.claimedByMe;
            openCount.textContent = stats.open;
            completeCount.textContent = stats.complete;
            
            // Display ideas
            let html = '';
            
            // Pending approvals section (for idea owners)
            if (pendingApprovals && pendingApprovals.length > 0) {
                html += '<div class="approval-section" style="margin-bottom: 40px;">';
                html += '<h3 style="margin-bottom: 20px; color: #f0ad4e;">Pending Approvals</h3>';
                html += '<div class="approval-cards">';
                pendingApprovals.forEach(approval => {
                    html += createApprovalCard(approval);
                });
                html += '</div>';
                html += '</div>';
            }
            
            // Pending claims section
            if (pendingClaims && pendingClaims.length > 0) {
                html += '<div class="pending-claims-section" style="margin-bottom: 40px;">';
                html += '<h3 style="margin-bottom: 20px; color: #17a2b8;">My Pending Claims</h3>';
                html += '<div class="ideas-grid">' + pendingClaims.map(idea => createPendingClaimCard(idea)).join('') + '</div>';
                html += '</div>';
            }
            
            // User's own ideas
            if (ideas.length > 0) {
                html += '<h3 style="margin-bottom: 20px;">My Ideas</h3>';
                html += '<div class="ideas-grid">' + ideas.map(idea => createIdeaCard(idea)).join('') + '</div>';
            }
            
            // Team members' ideas (for managers)
            if (teamIdeas && teamIdeas.length > 0 && managedTeam) {
                html += '<h3 style="margin-top: 40px; margin-bottom: 20px;">Team Members\' Ideas (' + utils.escapeHtml(managedTeam) + ')</h3>';
                html += '<div class="ideas-grid">' + teamIdeas.map(idea => createTeamIdeaCard(idea)).join('') + '</div>';
            }
            
            ideasContainer.innerHTML = html;
            
        } catch (error) {
            console.error('Error loading ideas:', error);
            ideasContainer.innerHTML = '<div class="error">Error loading your ideas. Please try again.</div>';
        }
    }
    
    // Create idea card HTML (similar to home page)
    function createIdeaCard(idea) {
        const statusClass = `status-${idea.status}`;
        const priorityClass = `priority-${idea.priority}`;
        
        const skillsHtml = idea.skills.map(skill => 
            `<span class="skill-tag">${utils.escapeHtml(skill.name)}</span>`
        ).join('');
        
        // Relationship indicator
        let relationshipBadge = '';
        let borderColor = '';
        if (idea.relationship === 'submitted') {
            relationshipBadge = '<span class="relationship-badge" style="background-color: #007bff;">Submitted by Me</span>';
            borderColor = '#007bff';
        } else if (idea.relationship === 'claimed') {
            relationshipBadge = '<span class="relationship-badge" style="background-color: #28a745;">Claimed by Me</span>';
            borderColor = '#28a745';
            // Add claim date if available
            if (idea.claim_info && idea.claim_info.claim_date) {
                relationshipBadge += `<span style="font-size: 12px; color: #666; margin-left: 10px;">Claimed: ${utils.formatDate(idea.claim_info.claim_date)}</span>`;
            }
        } else if (idea.relationship === 'both') {
            relationshipBadge = '<span class="relationship-badge" style="background-color: #6c757d;">Submitted & Claimed by Me</span>';
            borderColor = '#6c757d';
        }
        
        return `
            <div class="idea-card" onclick="window.location.href='/idea/${idea.id}'" style="border-left: 4px solid ${borderColor};">
                <div class="idea-header">
                    <h3 class="idea-title">${utils.escapeHtml(idea.title)}</h3>
                    <span class="status-badge ${statusClass}">${idea.status.toUpperCase()}</span>
                </div>
                
                ${relationshipBadge}
                
                <div class="idea-meta" style="margin-top: 10px;">
                    <span class="priority-badge ${priorityClass}">Priority: ${idea.priority}</span>
                    <span>Size: ${idea.size.replace('_', ' ')}</span>
                    <span>Team: ${utils.escapeHtml(idea.benefactor_team)}</span>
                </div>
                
                ${skillsHtml ? `<div class="skills-tags">${skillsHtml}</div>` : ''}
                
                <p class="idea-description">
                    ${utils.escapeHtml(idea.description.substring(0, 150))}${idea.description.length > 150 ? '...' : ''}
                </p>
                
                <div class="idea-footer">
                    <span>Submitted${idea.submitter_name ? ' by ' + utils.escapeHtml(idea.submitter_name) : ''}: ${utils.formatDate(idea.date_submitted)}</span>
                    ${idea.claims && idea.claims.length > 0 ? `<span>Claimed by: ${utils.escapeHtml(idea.claims[0].name)}</span>` : ''}
                    ${idea.claim_info && idea.claim_info.claimer_team ? `<span>Team: ${utils.escapeHtml(idea.claim_info.claimer_team)}</span>` : ''}
                </div>
                
                <a href="/idea/${idea.id}" class="view-details-link" onclick="event.stopPropagation()">View Details →</a>
            </div>
        `;
    }
    
    // Create team idea card HTML
    function createTeamIdeaCard(idea) {
        const statusClass = `status-${idea.status}`;
        const priorityClass = `priority-${idea.priority}`;
        
        const skillsHtml = idea.skills.map(skill => 
            `<span class="skill-tag">${utils.escapeHtml(skill.name)}</span>`
        ).join('');
        
        // Relationship indicator for team member
        let relationshipBadge = '';
        let borderColor = '#28a745'; // Green for team ideas
        if (idea.relationship === 'team_submitted') {
            relationshipBadge = `<span class="relationship-badge" style="background-color: #28a745;">Submitted by ${utils.escapeHtml(idea.member_name)}</span>`;
        } else if (idea.relationship === 'team_claimed') {
            relationshipBadge = `<span class="relationship-badge" style="background-color: #ffc107; color: #212529;">Claimed by ${utils.escapeHtml(idea.member_name)}</span>`;
        } else if (idea.relationship === 'team_both') {
            relationshipBadge = `<span class="relationship-badge" style="background-color: #17a2b8;">Submitted & Claimed by ${utils.escapeHtml(idea.member_name)}</span>`;
        }
        
        // Add assignment button for open ideas
        let assignmentButton = '';
        if (idea.status === 'open') {
            assignmentButton = `
                <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); showAssignmentModal(${idea.id}, '${utils.escapeHtml(idea.title).replace(/'/g, "\\'")}')" style="margin-top: 10px;">
                    Assign to Team Member
                </button>
            `;
        }
        
        return `
            <div class="idea-card" onclick="window.location.href='/idea/${idea.id}'" style="border-left: 4px solid ${borderColor};">
                <div class="idea-header">
                    <h3 class="idea-title">${utils.escapeHtml(idea.title)}</h3>
                    <span class="status-badge ${statusClass}">${idea.status.toUpperCase()}</span>
                </div>
                
                ${relationshipBadge}
                
                <div class="idea-meta" style="margin-top: 10px;">
                    <span class="priority-badge ${priorityClass}">Priority: ${idea.priority}</span>
                    <span>Size: ${idea.size.replace('_', ' ')}</span>
                    <span>Team: ${utils.escapeHtml(idea.benefactor_team)}</span>
                </div>
                
                ${skillsHtml ? `<div class="skills-tags">${skillsHtml}</div>` : ''}
                
                <p class="idea-description">
                    ${utils.escapeHtml(idea.description.substring(0, 150))}${idea.description.length > 150 ? '...' : ''}
                </p>
                
                <div class="idea-footer">
                    <span>Submitted${idea.submitter_name ? ' by ' + utils.escapeHtml(idea.submitter_name) : ''}: ${utils.formatDate(idea.date_submitted)}</span>
                    ${idea.claims && idea.claims.length > 0 ? `<span>Claimed by: ${utils.escapeHtml(idea.claims[0].name)}</span>` : ''}
                    ${idea.claim_info && idea.claim_info.claimer_team ? `<span>Team: ${utils.escapeHtml(idea.claim_info.claimer_team)}</span>` : ''}
                </div>
                
                ${assignmentButton}
                
                <a href="/idea/${idea.id}" class="view-details-link" onclick="event.stopPropagation()">View Details →</a>
            </div>
        `;
    }
    
    // Create approval card HTML
    function createApprovalCard(approval) {
        return `
            <div class="approval-card" style="border: 1px solid #f0ad4e; border-radius: 8px; padding: 20px; margin-bottom: 15px; background-color: #fff;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 10px 0; color: #333;">
                            <a href="/idea/${approval.idea_id}" style="color: #4a90e2; text-decoration: none;">${utils.escapeHtml(approval.idea_title)}</a>
                        </h4>
                        <p style="margin: 5px 0; color: #666;">
                            <strong>Requested by:</strong> ${utils.escapeHtml(approval.claimer_name)} (${utils.escapeHtml(approval.claimer_email)})
                        </p>
                        <p style="margin: 5px 0; color: #666;">
                            <strong>Team:</strong> ${utils.escapeHtml(approval.claimer_team || 'N/A')}
                        </p>
                        <p style="margin: 5px 0; color: #666; font-size: 0.9em;">
                            <strong>Submitted:</strong> ${utils.escapeHtml(approval.created_at)}
                        </p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="approveClaimRequest(${approval.id})" style="padding: 8px 16px;">
                            Approve
                        </button>
                        <button class="btn btn-danger" onclick="denyClaimRequest(${approval.id})" style="padding: 8px 16px;">
                            Deny
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Create pending claim card HTML
    function createPendingClaimCard(idea) {
        const isDenied = idea.pending_approval && idea.pending_approval.status === 'denied';
        const statusClass = isDenied ? 'status-denied' : 'status-pending';
        const borderColor = isDenied ? '#dc3545' : '#17a2b8';
        const statusText = isDenied ? 'CLAIM DENIED' : 'PENDING CLAIM';
        const priorityClass = `priority-${idea.priority}`;
        
        const skillsHtml = idea.skills.map(skill => 
            `<span class="skill-tag">${utils.escapeHtml(skill.name)}</span>`
        ).join('');
        
        // Show approval status
        let approvalStatus = '';
        if (idea.pending_approval) {
            const ownerStatus = idea.pending_approval.owner_approved === null ? 'Pending' : 
                               idea.pending_approval.owner_approved ? 'Approved' : 'Denied';
            const managerStatus = idea.pending_approval.manager_approved === null ? 'Pending' : 
                                 idea.pending_approval.manager_approved ? 'Approved' : 'Denied';
            
            approvalStatus = `
                <div style="margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 4px; font-size: 0.9em;">
                    <p style="margin: 3px 0;"><strong>Idea Owner:</strong> 
                        <span style="color: ${ownerStatus === 'Approved' ? '#28a745' : ownerStatus === 'Denied' ? '#dc3545' : '#f0ad4e'}">
                            ${ownerStatus}
                        </span>
                    </p>
                    <p style="margin: 3px 0;"><strong>Your Manager:</strong> 
                        <span style="color: ${managerStatus === 'Approved' ? '#28a745' : managerStatus === 'Denied' ? '#dc3545' : '#f0ad4e'}">
                            ${managerStatus}
                        </span>
                    </p>
                    ${isDenied && idea.pending_approval.denied_at ? 
                        `<p style="margin: 3px 0; color: #dc3545;"><strong>Denied on:</strong> ${utils.formatDate(idea.pending_approval.denied_at)}</p>` : ''}
                </div>
            `;
        }
        
        return `
            <div class="idea-card" onclick="window.location.href='/idea/${idea.id}'" style="border-left: 4px solid ${borderColor};">
                <div class="idea-header">
                    <h3 class="idea-title">${utils.escapeHtml(idea.title)}</h3>
                    <span class="status-badge ${statusClass}">${statusText}</span>
                </div>
                
                <div class="idea-meta">
                    <span class="priority-badge ${priorityClass}">Priority: ${idea.priority}</span>
                    <span>Size: ${idea.size.replace('_', ' ')}</span>
                    <span>Team: ${utils.escapeHtml(idea.benefactor_team)}</span>
                </div>
                
                ${approvalStatus}
                
                ${skillsHtml ? `<div class="skills-tags">${skillsHtml}</div>` : ''}
                
                <p class="idea-description">
                    ${utils.escapeHtml(idea.description.substring(0, 150))}${idea.description.length > 150 ? '...' : ''}
                </p>
                
                <div class="idea-footer">
                    <span>Submitted${idea.submitter_name ? ' by ' + utils.escapeHtml(idea.submitter_name) : ''}: ${utils.formatDate(idea.date_submitted)}</span>
                    <span>Claim requested: ${utils.formatDate(idea.pending_approval.created_at)}</span>
                </div>
                
                <a href="/idea/${idea.id}" class="view-details-link" onclick="event.stopPropagation()">View Details →</a>
            </div>
        `;
    }
    
    // Handle email lookup
    lookupBtn.addEventListener('click', async () => {
        const email = emailInput.value.trim();
        if (!email) {
            lookupError.textContent = 'Please enter a valid email address';
            lookupError.style.display = 'block';
            return;
        }
        
        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            lookupError.textContent = 'Please enter a valid email address';
            lookupError.style.display = 'block';
            return;
        }
        
        lookupError.style.display = 'none';
        ideasContainer.innerHTML = '<div class="loading">Loading your ideas...</div>';
        
        // Load ideas for this email
        await loadMyIdeas(email);
    });
    
    // Handle enter key in email input
    emailInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            lookupBtn.click();
        }
    });
    
    // Initialize
    loadMyIdeas();
    
    // Approve claim request
    window.approveClaimRequest = async function(approvalId) {
        try {
            const response = await fetch(`/api/claim-approvals/${approvalId}/approve`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            if (data.success) {
                alert('Claim approved successfully!');
                loadMyIdeas(currentEmail);  // Refresh the page
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            console.error('Error approving claim:', error);
            alert('Failed to approve claim request');
        }
    };
    
    // Deny claim request
    window.denyClaimRequest = async function(approvalId) {
        if (!confirm('Are you sure you want to deny this claim request?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/claim-approvals/${approvalId}/deny`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            if (data.success) {
                alert('Claim denied');
                loadMyIdeas(currentEmail);  // Refresh the page
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            console.error('Error denying claim:', error);
            alert('Failed to deny claim request');
        }
    };
    
    // Show assignment modal
    window.showAssignmentModal = function(ideaId, ideaTitle) {
        // Get team members for assignment
        fetchTeamMembers().then(members => {
            const memberOptions = members.map(m => 
                `<option value="${m.email}">${utils.escapeHtml(m.name)} (${utils.escapeHtml(m.email)})</option>`
            ).join('');
            
            const modalHtml = `
                <div id="assignmentModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
                        <h3 style="margin-top: 0;">Assign Idea</h3>
                        <p style="color: #666; margin-bottom: 20px;">Assign "${utils.escapeHtml(ideaTitle)}" to a team member</p>
                        
                        <div style="margin-bottom: 20px;">
                            <label for="assignee" style="display: block; margin-bottom: 5px; font-weight: 600;">Select Team Member:</label>
                            <select id="assignee" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">-- Select a team member --</option>
                                ${memberOptions}
                            </select>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="closeAssignmentModal()" style="padding: 8px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                            <button onclick="assignIdea(${ideaId})" style="padding: 8px 20px; background: #4a90e2; color: white; border: none; border-radius: 4px; cursor: pointer;">Assign</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        });
    };
    
    // Close assignment modal
    window.closeAssignmentModal = function() {
        const modal = document.getElementById('assignmentModal');
        if (modal) {
            modal.remove();
        }
    };
    
    // Assign idea to team member
    window.assignIdea = async function(ideaId) {
        const assigneeEmail = document.getElementById('assignee').value;
        if (!assigneeEmail) {
            alert('Please select a team member');
            return;
        }
        
        try {
            const response = await fetch(`/api/ideas/${ideaId}/assign`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ assignee_email: assigneeEmail })
            });
            
            const data = await response.json();
            if (data.success) {
                alert(data.message);
                closeAssignmentModal();
                loadMyIdeas(currentEmail);  // Refresh
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            console.error('Error assigning idea:', error);
            alert('Failed to assign idea');
        }
    };
    
    // Fetch team members for assignment
    async function fetchTeamMembers() {
        const managedTeamId = {{ session.get('user_managed_team_id', 'null') }};
        if (!managedTeamId) {
            return [];
        }
        
        try {
            const response = await fetch(`/api/teams/${managedTeamId}/members`);
            if (response.ok) {
                return await response.json();
            }
            return [];
        } catch (error) {
            console.error('Error fetching team members:', error);
            return [];
        }
    }
    
    // Auto-refresh every 30 seconds (only if not using email lookup)
    setInterval(() => {
        if (!currentEmail) {
            loadMyIdeas();
        } else {
            loadMyIdeas(currentEmail);
        }
    }, 30000);
})();
</script>
{% endblock %}
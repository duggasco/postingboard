{% extends "base.html" %}

{% block title %}My Ideas - Citizen Developer Posting Board{% endblock %}

{% block content %}
<div class="page-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 class="page-title" style="margin: 0;">My Ideas</h2>
        <button id="notification-bell" class="notification-bell" onclick="toggleNotifications()">
            <span class="notification-icon">ðŸ””</span>
            <span id="notification-count" class="notification-badge" style="display: none;">0</span>
        </button>
    </div>
    
    <!-- Notifications Panel -->
    <div id="notifications-panel" class="notifications-panel" style="display: none;">
        <div class="notifications-header">
            <h3>Notifications</h3>
            <button class="close-btn" onclick="toggleNotifications()">Ã—</button>
        </div>
        <div id="notifications-list" class="notifications-list">
            <div class="loading">Loading notifications...</div>
        </div>
    </div>
    
    <div id="stats-container" class="stats-grid" style="margin-bottom: 30px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
        <div class="stat-card">
            <h3 id="submitted-count">0</h3>
            <p>Submitted</p>
        </div>
        <div class="stat-card">
            <h3 id="claimed-by-me-count">0</h3>
            <p>Claimed by Me</p>
        </div>
        <div class="stat-card">
            <h3 id="open-count">0</h3>
            <p>Open</p>
        </div>
        <div class="stat-card">
            <h3 id="complete-count">0</h3>
            <p>Complete</p>
        </div>
    </div>
    
    <!-- Team KPIs Section (for managers only) -->
    <div id="team-kpis-section" style="display: none;">
        <h3 style="margin: 40px 0 20px 0; color: #1a1d23;">Team Performance Dashboard</h3>
        
        <!-- Team Overview Stats -->
        <div class="stats-grid" style="margin-bottom: 30px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px;">
            <div class="stat-card">
                <h3 id="team-members-count">0</h3>
                <p>Team Members</p>
            </div>
            <div class="stat-card">
                <h3 id="team-submitted-count">0</h3>
                <p>Ideas Submitted</p>
            </div>
            <div class="stat-card">
                <h3 id="team-claimed-count">0</h3>
                <p>Ideas Claimed</p>
            </div>
            <div class="stat-card">
                <h3 id="team-completion-rate">0%</h3>
                <p>Completion Rate</p>
            </div>
            <div class="stat-card">
                <h3 id="team-pending-approvals">0</h3>
                <p>Pending Approvals</p>
            </div>
        </div>
        
        <!-- Team Activity Charts -->
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; margin-bottom: 40px;">
            <!-- Priority Breakdown -->
            <div class="chart-container" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                <h4 style="margin-bottom: 20px; color: #495057;">Ideas by Priority</h4>
                <canvas id="priority-chart" style="max-height: 250px;"></canvas>
            </div>
            
            <!-- Status Breakdown -->
            <div class="chart-container" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                <h4 style="margin-bottom: 20px; color: #495057;">Claimed Ideas by Status</h4>
                <canvas id="status-chart" style="max-height: 250px;"></canvas>
            </div>
        </div>
        
        <!-- Size and Skills Charts -->
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; margin-bottom: 40px;">
            <!-- Size Breakdown -->
            <div class="chart-container" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                <h4 style="margin-bottom: 20px; color: #495057;">Ideas by Size</h4>
                <canvas id="size-chart" style="max-height: 250px;"></canvas>
            </div>
            
            <!-- Top Skills -->
            <div class="chart-container" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                <h4 style="margin-bottom: 20px; color: #495057;">Top Skills (Claimed Ideas)</h4>
                <canvas id="skills-chart" style="max-height: 250px;"></canvas>
            </div>
        </div>
        
        <!-- Team Member Activity Table -->
        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); margin-bottom: 40px;">
            <h4 style="margin-bottom: 20px; color: #495057;">Team Member Activity</h4>
            <table class="data-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Team Member</th>
                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">Ideas Submitted</th>
                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">Ideas Claimed</th>
                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">Completed</th>
                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">Total Activity</th>
                    </tr>
                </thead>
                <tbody id="team-activity-tbody">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>
        
        <!-- Recent Activity -->
        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); margin-bottom: 40px;">
            <h4 style="margin-bottom: 20px; color: #495057;">Recent Team Activity (Last 30 Days)</h4>
            <div style="display: flex; gap: 40px;">
                <div>
                    <h2 id="recent-submissions" style="color: #4a90e2; margin: 0;">0</h2>
                    <p style="margin: 5px 0 0 0; color: #6c757d;">Submissions</p>
                </div>
                <div>
                    <h2 id="recent-claims" style="color: #28a745; margin: 0;">0</h2>
                    <p style="margin: 5px 0 0 0; color: #6c757d;">Claims</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="my-ideas-container" class="ideas-grid">
        <div class="loading">Loading your ideas...</div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.relationship-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 4px;
    color: white;
    font-size: 12px;
    font-weight: bold;
    margin-top: 5px;
}
</style>
{% endblock %}

{% block extra_js %}
<style>
.notification-bell {
    position: relative;
    background: none;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 8px 12px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.notification-bell:hover {
    background: #f8f9fa;
    border-color: #adb5bd;
}

.notification-icon {
    font-size: 20px;
}

.notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #dc3545;
    color: white;
    border-radius: 10px;
    padding: 2px 6px;
    font-size: 11px;
    font-weight: bold;
    min-width: 18px;
    text-align: center;
}

.notifications-panel {
    position: fixed;
    top: 70px;
    right: 20px;
    width: 400px;
    max-height: 600px;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.notifications-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #dee2e6;
    background: #f8f9fa;
}

.notifications-header h3 {
    margin: 0;
    font-size: 1.1rem;
    color: #1a1d23;
}

.close-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #6c757d;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.notifications-list {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
}

.notification-item {
    padding: 15px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.notification-item:hover {
    background: #f8f9fa;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.notification-item.unread {
    background: #e3f2fd;
    border-color: #4a90e2;
}

.notification-title {
    font-weight: 600;
    color: #1a1d23;
    margin-bottom: 5px;
}

.notification-message {
    color: #6c757d;
    font-size: 13px;
    margin-bottom: 5px;
}

.notification-time {
    color: #868e96;
    font-size: 11px;
}

.notification-type-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    margin-left: 10px;
}

.type-claim_request {
    background: #fff3cd;
    color: #856404;
}

.type-claim_approved {
    background: #d4edda;
    color: #155724;
}

.type-claim_denied {
    background: #f8d7da;
    color: #721c24;
}

.type-status_change {
    background: #d1ecf1;
    color: #0c5460;
}

.type-assigned {
    background: #e2e3e5;
    color: #383d41;
}

.empty-notifications {
    text-align: center;
    padding: 40px 20px;
    color: #6c757d;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
// Notifications functionality
let notificationsPanelOpen = false;

async function loadNotifications() {
    try {
        const response = await fetch('/api/user/notifications');
        const data = await response.json();
        
        if (data.success) {
            const notificationsList = document.getElementById('notifications-list');
            const notificationCount = document.getElementById('notification-count');
            
            if (data.notifications.length === 0) {
                notificationsList.innerHTML = '<div class="empty-notifications">No notifications</div>';
                notificationCount.style.display = 'none';
            } else {
                let html = '';
                data.notifications.forEach(notif => {
                    const typeClass = `type-${notif.type}`;
                    const unreadClass = notif.is_read ? '' : 'unread';
                    
                    html += `
                        <div class="notification-item ${unreadClass}" onclick="handleNotificationClick(${notif.id}, ${notif.idea_id || 'null'})">
                            <div class="notification-title">
                                ${notif.title}
                                <span class="notification-type-badge ${typeClass}">${formatNotificationType(notif.type)}</span>
                            </div>
                            <div class="notification-message">${notif.message}</div>
                            <div class="notification-time">${notif.time_ago}</div>
                        </div>
                    `;
                });
                notificationsList.innerHTML = html;
                
                // Update badge
                if (data.unread_count > 0) {
                    notificationCount.textContent = data.unread_count;
                    notificationCount.style.display = 'inline-block';
                } else {
                    notificationCount.style.display = 'none';
                }
            }
        }
    } catch (error) {
        console.error('Error loading notifications:', error);
    }
}

function formatNotificationType(type) {
    const typeMap = {
        'claim_request': 'Claim Request',
        'claim_approved': 'Approved',
        'claim_denied': 'Denied',
        'status_change': 'Status Update',
        'assigned': 'Assigned',
        'new_team_member': 'Team Update'
    };
    return typeMap[type] || type;
}

function toggleNotifications() {
    const panel = document.getElementById('notifications-panel');
    notificationsPanelOpen = !notificationsPanelOpen;
    panel.style.display = notificationsPanelOpen ? 'flex' : 'none';
    
    if (notificationsPanelOpen) {
        loadNotifications();
    }
}

async function handleNotificationClick(notificationId, ideaId) {
    // Mark as read
    await fetch(`/api/user/notifications/${notificationId}/read`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    });
    
    // Refresh notifications
    loadNotifications();
    
    // Navigate to idea if applicable
    if (ideaId) {
        window.location.href = `/idea/${ideaId}`;
    }
}

// Load notifications on page load
document.addEventListener('DOMContentLoaded', function() {
    loadNotifications();
    
    // Refresh notifications every 30 seconds
    setInterval(loadNotifications, 30000);
});

// Close notifications panel when clicking outside
document.addEventListener('click', function(event) {
    const bell = document.getElementById('notification-bell');
    const panel = document.getElementById('notifications-panel');
    
    if (notificationsPanelOpen && !bell.contains(event.target) && !panel.contains(event.target)) {
        toggleNotifications();
    }
});

(function() {
    // Elements
    const ideasContainer = document.getElementById('my-ideas-container');
    const submittedCount = document.getElementById('submitted-count');
    const claimedByMeCount = document.getElementById('claimed-by-me-count');
    const openCount = document.getElementById('open-count');
    const completeCount = document.getElementById('complete-count');
    
    // Load user's ideas
    async function loadMyIdeas() {
        try {
            const response = await utils.fetchJson('/api/my-ideas');
            
            // Check if response is an object with user_ideas and team_ideas
            const isManagerResponse = response && typeof response === 'object' && 'user_ideas' in response;
            const ideas = isManagerResponse ? response.user_ideas : response;
            const teamIdeas = isManagerResponse ? response.team_ideas : [];
            const managedTeam = isManagerResponse ? response.managed_team : null;
            const pendingClaims = isManagerResponse ? response.pending_claims : [];
            const pendingApprovals = isManagerResponse ? response.pending_approvals : [];
            
            if (ideas.length === 0) {
                // No ideas found
                ideasContainer.innerHTML = `
                    <div class="empty-state">
                        <h3>No ideas found</h3>
                        <p>You haven't submitted or claimed any ideas yet.</p>
                        <p><a href="/submit" class="btn btn-primary">Submit your first idea</a></p>
                    </div>
                `;
                submittedCount.textContent = '0';
                claimedByMeCount.textContent = '0';
                openCount.textContent = '0';
                completeCount.textContent = '0';
                return;
            }
            
            // Calculate stats
            const stats = {
                submitted: 0,
                claimedByMe: 0,
                open: 0,
                complete: 0
            };
            
            ideas.forEach(idea => {
                // Count by relationship
                if (idea.relationship === 'submitted' || idea.relationship === 'both') {
                    stats.submitted++;
                }
                if (idea.relationship === 'claimed' || idea.relationship === 'both') {
                    stats.claimedByMe++;
                }
                
                // Count by status
                if (idea.status === 'open') {
                    stats.open++;
                } else if (idea.status === 'complete') {
                    stats.complete++;
                }
            });
            
            // Update stats
            submittedCount.textContent = stats.submitted;
            claimedByMeCount.textContent = stats.claimedByMe;
            openCount.textContent = stats.open;
            completeCount.textContent = stats.complete;
            
            // Display ideas
            let html = '';
            
            // Pending approvals section (for idea owners)
            if (pendingApprovals && pendingApprovals.length > 0) {
                html += '<div class="approval-section" style="margin-bottom: 40px;">';
                html += '<h3 style="margin-bottom: 20px; color: #f0ad4e;">Pending Approvals</h3>';
                html += '<div class="approval-cards">';
                pendingApprovals.forEach(approval => {
                    html += createApprovalCard(approval);
                });
                html += '</div>';
                html += '</div>';
            }
            
            // Pending claims section
            if (pendingClaims && pendingClaims.length > 0) {
                html += '<div class="pending-claims-section" style="margin-bottom: 40px;">';
                html += '<h3 style="margin-bottom: 20px; color: #17a2b8;">My Pending Claims</h3>';
                html += '<div class="ideas-grid">' + pendingClaims.map(idea => createPendingClaimCard(idea)).join('') + '</div>';
                html += '</div>';
            }
            
            // User's own ideas
            if (ideas.length > 0) {
                html += '<h3 style="margin-bottom: 20px;">My Ideas</h3>';
                html += '<div class="ideas-grid">' + ideas.map(idea => createIdeaCard(idea)).join('') + '</div>';
            }
            
            // Team members' ideas (for managers)
            if (teamIdeas && teamIdeas.length > 0 && managedTeam) {
                html += '<h3 style="margin-top: 40px; margin-bottom: 20px;">Team Members\' Ideas (' + utils.escapeHtml(managedTeam) + ')</h3>';
                html += '<div class="ideas-grid">' + teamIdeas.map(idea => createTeamIdeaCard(idea)).join('') + '</div>';
            }
            
            ideasContainer.innerHTML = html;
            
        } catch (error) {
            console.error('Error loading ideas:', error);
            ideasContainer.innerHTML = '<div class="error">Error loading your ideas. Please try again.</div>';
        }
    }
    
    // Create idea card HTML (similar to home page)
    function createIdeaCard(idea) {
        const statusClass = `status-${idea.status}`;
        const priorityClass = `priority-${idea.priority}`;
        
        const skillsHtml = idea.skills.map(skill => 
            `<span class="skill-tag">${utils.escapeHtml(skill.name)}</span>`
        ).join('');
        
        // Relationship indicator
        let relationshipBadge = '';
        let borderColor = '';
        if (idea.relationship === 'submitted') {
            relationshipBadge = '<span class="relationship-badge" style="background-color: #007bff;">Submitted by Me</span>';
            borderColor = '#007bff';
        } else if (idea.relationship === 'claimed') {
            relationshipBadge = '<span class="relationship-badge" style="background-color: #28a745;">Claimed by Me</span>';
            borderColor = '#28a745';
            // Add claim date if available
            if (idea.claim_info && idea.claim_info.claim_date) {
                relationshipBadge += `<span style="font-size: 12px; color: #666; margin-left: 10px;">Claimed: ${utils.formatDate(idea.claim_info.claim_date)}</span>`;
            }
        } else if (idea.relationship === 'both') {
            relationshipBadge = '<span class="relationship-badge" style="background-color: #6c757d;">Submitted & Claimed by Me</span>';
            borderColor = '#6c757d';
        }
        
        return `
            <div class="idea-card" onclick="window.location.href='/idea/${idea.id}'" style="border-left: 4px solid ${borderColor};">
                <div class="idea-header">
                    <h3 class="idea-title">${utils.escapeHtml(idea.title)}</h3>
                    <span class="status-badge ${statusClass}">${idea.status.toUpperCase()}</span>
                </div>
                
                ${relationshipBadge}
                
                <div class="idea-meta" style="margin-top: 10px;">
                    <span class="priority-badge ${priorityClass}">Priority: ${idea.priority}</span>
                    <span>Size: ${idea.size.replace('_', ' ')}</span>
                    <span>Team: ${utils.escapeHtml(idea.benefactor_team)}</span>
                </div>
                
                ${skillsHtml ? `<div class="skills-tags">${skillsHtml}</div>` : ''}
                
                <p class="idea-description">
                    ${utils.escapeHtml(idea.description.substring(0, 150))}${idea.description.length > 150 ? '...' : ''}
                </p>
                
                <div class="idea-footer">
                    <span>Submitted${idea.submitter_name ? ' by ' + utils.escapeHtml(idea.submitter_name) : ''}: ${utils.formatDate(idea.date_submitted)}</span>
                    ${idea.claims && idea.claims.length > 0 ? `<span>Claimed by: ${utils.escapeHtml(idea.claims[0].name)}</span>` : ''}
                    ${idea.claim_info && idea.claim_info.claimer_team ? `<span>Team: ${utils.escapeHtml(idea.claim_info.claimer_team)}</span>` : ''}
                </div>
                
                <a href="/idea/${idea.id}" class="view-details-link" onclick="event.stopPropagation()">View Details â†’</a>
            </div>
        `;
    }
    
    // Create team idea card HTML
    function createTeamIdeaCard(idea) {
        const statusClass = `status-${idea.status}`;
        const priorityClass = `priority-${idea.priority}`;
        
        const skillsHtml = idea.skills.map(skill => 
            `<span class="skill-tag">${utils.escapeHtml(skill.name)}</span>`
        ).join('');
        
        // Relationship indicator for team member
        let relationshipBadge = '';
        let borderColor = '#28a745'; // Green for team ideas
        if (idea.relationship === 'team_submitted') {
            relationshipBadge = `<span class="relationship-badge" style="background-color: #28a745;">Submitted by ${utils.escapeHtml(idea.member_name)}</span>`;
        } else if (idea.relationship === 'team_claimed') {
            relationshipBadge = `<span class="relationship-badge" style="background-color: #ffc107; color: #212529;">Claimed by ${utils.escapeHtml(idea.member_name)}</span>`;
        } else if (idea.relationship === 'team_both') {
            relationshipBadge = `<span class="relationship-badge" style="background-color: #17a2b8;">Submitted & Claimed by ${utils.escapeHtml(idea.member_name)}</span>`;
        }
        
        // Add assignment button for open ideas
        let assignmentButton = '';
        if (idea.status === 'open') {
            assignmentButton = `
                <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); showAssignmentModal(${idea.id}, '${utils.escapeHtml(idea.title).replace(/'/g, "\\'")}')" style="margin-top: 10px;">
                    Assign to Team Member
                </button>
            `;
        }
        
        return `
            <div class="idea-card" onclick="window.location.href='/idea/${idea.id}'" style="border-left: 4px solid ${borderColor};">
                <div class="idea-header">
                    <h3 class="idea-title">${utils.escapeHtml(idea.title)}</h3>
                    <span class="status-badge ${statusClass}">${idea.status.toUpperCase()}</span>
                </div>
                
                ${relationshipBadge}
                
                <div class="idea-meta" style="margin-top: 10px;">
                    <span class="priority-badge ${priorityClass}">Priority: ${idea.priority}</span>
                    <span>Size: ${idea.size.replace('_', ' ')}</span>
                    <span>Team: ${utils.escapeHtml(idea.benefactor_team)}</span>
                </div>
                
                ${skillsHtml ? `<div class="skills-tags">${skillsHtml}</div>` : ''}
                
                <p class="idea-description">
                    ${utils.escapeHtml(idea.description.substring(0, 150))}${idea.description.length > 150 ? '...' : ''}
                </p>
                
                <div class="idea-footer">
                    <span>Submitted${idea.submitter_name ? ' by ' + utils.escapeHtml(idea.submitter_name) : ''}: ${utils.formatDate(idea.date_submitted)}</span>
                    ${idea.claims && idea.claims.length > 0 ? `<span>Claimed by: ${utils.escapeHtml(idea.claims[0].name)}</span>` : ''}
                    ${idea.claim_info && idea.claim_info.claimer_team ? `<span>Team: ${utils.escapeHtml(idea.claim_info.claimer_team)}</span>` : ''}
                </div>
                
                ${assignmentButton}
                
                <a href="/idea/${idea.id}" class="view-details-link" onclick="event.stopPropagation()">View Details â†’</a>
            </div>
        `;
    }
    
    // Create approval card HTML
    function createApprovalCard(approval) {
        return `
            <div class="approval-card" style="border: 1px solid #f0ad4e; border-radius: 8px; padding: 20px; margin-bottom: 15px; background-color: #fff;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 10px 0; color: #333;">
                            <a href="/idea/${approval.idea_id}" style="color: #4a90e2; text-decoration: none;">${utils.escapeHtml(approval.idea_title)}</a>
                        </h4>
                        <p style="margin: 5px 0; color: #666;">
                            <strong>Requested by:</strong> ${utils.escapeHtml(approval.claimer_name)} (${utils.escapeHtml(approval.claimer_email)})
                        </p>
                        <p style="margin: 5px 0; color: #666;">
                            <strong>Team:</strong> ${utils.escapeHtml(approval.claimer_team || 'N/A')}
                        </p>
                        <p style="margin: 5px 0; color: #666; font-size: 0.9em;">
                            <strong>Submitted:</strong> ${utils.escapeHtml(approval.created_at)}
                        </p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="approveClaimRequest(${approval.id})" style="padding: 8px 16px;">
                            Approve
                        </button>
                        <button class="btn btn-danger" onclick="denyClaimRequest(${approval.id})" style="padding: 8px 16px;">
                            Deny
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Create pending claim card HTML
    function createPendingClaimCard(idea) {
        const isDenied = idea.pending_approval && idea.pending_approval.status === 'denied';
        const statusClass = isDenied ? 'status-denied' : 'status-pending';
        const borderColor = isDenied ? '#dc3545' : '#17a2b8';
        const statusText = isDenied ? 'CLAIM DENIED' : 'PENDING CLAIM';
        const priorityClass = `priority-${idea.priority}`;
        
        const skillsHtml = idea.skills.map(skill => 
            `<span class="skill-tag">${utils.escapeHtml(skill.name)}</span>`
        ).join('');
        
        // Show approval status
        let approvalStatus = '';
        if (idea.pending_approval) {
            const ownerStatus = idea.pending_approval.owner_approved === null ? 'Pending' : 
                               idea.pending_approval.owner_approved ? 'Approved' : 'Denied';
            const managerStatus = idea.pending_approval.manager_approved === null ? 'Pending' : 
                                 idea.pending_approval.manager_approved ? 'Approved' : 'Denied';
            
            approvalStatus = `
                <div style="margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 4px; font-size: 0.9em;">
                    <p style="margin: 3px 0;"><strong>Idea Owner:</strong> 
                        <span style="color: ${ownerStatus === 'Approved' ? '#28a745' : ownerStatus === 'Denied' ? '#dc3545' : '#f0ad4e'}">
                            ${ownerStatus}
                        </span>
                    </p>
                    <p style="margin: 3px 0;"><strong>Your Manager:</strong> 
                        <span style="color: ${managerStatus === 'Approved' ? '#28a745' : managerStatus === 'Denied' ? '#dc3545' : '#f0ad4e'}">
                            ${managerStatus}
                        </span>
                    </p>
                    ${isDenied && idea.pending_approval.denied_at ? 
                        `<p style="margin: 3px 0; color: #dc3545;"><strong>Denied on:</strong> ${utils.formatDate(idea.pending_approval.denied_at)}</p>` : ''}
                </div>
            `;
        }
        
        return `
            <div class="idea-card" onclick="window.location.href='/idea/${idea.id}'" style="border-left: 4px solid ${borderColor};">
                <div class="idea-header">
                    <h3 class="idea-title">${utils.escapeHtml(idea.title)}</h3>
                    <span class="status-badge ${statusClass}">${statusText}</span>
                </div>
                
                <div class="idea-meta">
                    <span class="priority-badge ${priorityClass}">Priority: ${idea.priority}</span>
                    <span>Size: ${idea.size.replace('_', ' ')}</span>
                    <span>Team: ${utils.escapeHtml(idea.benefactor_team)}</span>
                </div>
                
                ${approvalStatus}
                
                ${skillsHtml ? `<div class="skills-tags">${skillsHtml}</div>` : ''}
                
                <p class="idea-description">
                    ${utils.escapeHtml(idea.description.substring(0, 150))}${idea.description.length > 150 ? '...' : ''}
                </p>
                
                <div class="idea-footer">
                    <span>Submitted${idea.submitter_name ? ' by ' + utils.escapeHtml(idea.submitter_name) : ''}: ${utils.formatDate(idea.date_submitted)}</span>
                    <span>Claim requested: ${utils.formatDate(idea.pending_approval.created_at)}</span>
                </div>
                
                <a href="/idea/${idea.id}" class="view-details-link" onclick="event.stopPropagation()">View Details â†’</a>
            </div>
        `;
    }
    
    
    // Load team statistics for managers
    async function loadTeamStats() {
        try {
            const response = await utils.fetchJson('/api/team-stats');
            const stats = response;
            
            // Update overview stats
            document.getElementById('team-members-count').textContent = stats.overview.total_members;
            document.getElementById('team-submitted-count').textContent = stats.overview.ideas_submitted;
            document.getElementById('team-claimed-count').textContent = stats.overview.ideas_claimed;
            document.getElementById('team-completion-rate').textContent = stats.overview.completion_rate + '%';
            document.getElementById('team-pending-approvals').textContent = stats.overview.pending_approvals;
            
            // Update recent activity
            document.getElementById('recent-submissions').textContent = stats.recent_activity.submissions_30d;
            document.getElementById('recent-claims').textContent = stats.recent_activity.claims_30d;
            
            // Create charts
            createTeamCharts(stats.breakdowns);
            
            // Populate team member activity table
            populateTeamActivityTable(stats.member_activity);
            
            // Show the KPIs section
            document.getElementById('team-kpis-section').style.display = 'block';
            
        } catch (error) {
            console.error('Error loading team stats:', error);
            // Don't show error to user, just hide the section
            document.getElementById('team-kpis-section').style.display = 'none';
        }
    }
    
    // Create team performance charts
    function createTeamCharts(breakdowns) {
        // Priority chart
        const priorityCtx = document.getElementById('priority-chart').getContext('2d');
        new Chart(priorityCtx, {
            type: 'doughnut',
            data: {
                labels: ['High', 'Medium', 'Low'],
                datasets: [{
                    data: [
                        breakdowns.priority.high || 0,
                        breakdowns.priority.medium || 0,
                        breakdowns.priority.low || 0
                    ],
                    backgroundColor: ['#dc3545', '#f0ad4e', '#28a745']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        
        // Status chart
        const statusCtx = document.getElementById('status-chart').getContext('2d');
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Open', 'Claimed', 'Complete'],
                datasets: [{
                    data: [
                        breakdowns.status.open || 0,
                        breakdowns.status.claimed || 0,
                        breakdowns.status.complete || 0
                    ],
                    backgroundColor: ['#17a2b8', '#f0ad4e', '#28a745']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        
        // Size chart
        const sizeCtx = document.getElementById('size-chart').getContext('2d');
        new Chart(sizeCtx, {
            type: 'bar',
            data: {
                labels: ['Small', 'Medium', 'Large', 'Extra Large'],
                datasets: [{
                    label: 'Ideas',
                    data: [
                        breakdowns.size.small || 0,
                        breakdowns.size.medium || 0,
                        breakdowns.size.large || 0,
                        breakdowns.size.extra_large || 0
                    ],
                    backgroundColor: '#4a90e2'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
        
        // Skills chart
        const skillsCtx = document.getElementById('skills-chart').getContext('2d');
        const skillLabels = breakdowns.skills.map(s => s.skill);
        const skillCounts = breakdowns.skills.map(s => s.count);
        
        new Chart(skillsCtx, {
            type: 'bar',
            data: {
                labels: skillLabels,
                datasets: [{
                    label: 'Count',
                    data: skillCounts,
                    backgroundColor: '#6c757d'
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
    
    // Populate team member activity table
    function populateTeamActivityTable(memberActivity) {
        const tbody = document.getElementById('team-activity-tbody');
        tbody.innerHTML = '';
        
        memberActivity.forEach(member => {
            const row = document.createElement('tr');
            const totalActivity = member.submitted + member.claimed;
            
            row.innerHTML = `
                <td style="padding: 12px; border-bottom: 1px solid #dee2e6;">
                    <strong>${utils.escapeHtml(member.name)}</strong><br>
                    <small style="color: #6c757d;">${utils.escapeHtml(member.email)}</small>
                </td>
                <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${member.submitted}</td>
                <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${member.claimed}</td>
                <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${member.completed}</td>
                <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;"><strong>${totalActivity}</strong></td>
            `;
            
            tbody.appendChild(row);
        });
        
        if (memberActivity.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #6c757d;">No team member activity found</td></tr>';
        }
    }
    
    // Check if user is a manager and load team stats
    async function checkManagerAndLoadStats() {
        // This will be called after loading my ideas
        const userRole = '{{ session.get("user_role", "") }}';
        const hasManagedTeam = '{{ session.get("user_managed_team_id", "") }}';
        
        if (userRole === 'manager' && hasManagedTeam) {
            await loadTeamStats();
        }
    }
    
    // Initialize
    loadMyIdeas().then(() => {
        checkManagerAndLoadStats();
    });
    
    // Approve claim request
    window.approveClaimRequest = async function(approvalId) {
        try {
            const response = await fetch(`/api/claim-approvals/${approvalId}/approve`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            if (data.success) {
                alert('Claim approved successfully!');
                loadMyIdeas();  // Refresh the page
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            console.error('Error approving claim:', error);
            alert('Failed to approve claim request');
        }
    };
    
    // Deny claim request
    window.denyClaimRequest = async function(approvalId) {
        if (!confirm('Are you sure you want to deny this claim request?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/claim-approvals/${approvalId}/deny`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            if (data.success) {
                alert('Claim denied');
                loadMyIdeas();  // Refresh the page
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            console.error('Error denying claim:', error);
            alert('Failed to deny claim request');
        }
    };
    
    // Show assignment modal
    window.showAssignmentModal = function(ideaId, ideaTitle) {
        // Get team members for assignment
        fetchTeamMembers().then(members => {
            const memberOptions = members.map(m => 
                `<option value="${m.email}">${utils.escapeHtml(m.name)} (${utils.escapeHtml(m.email)})</option>`
            ).join('');
            
            const modalHtml = `
                <div id="assignmentModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
                        <h3 style="margin-top: 0;">Assign Idea</h3>
                        <p style="color: #666; margin-bottom: 20px;">Assign "${utils.escapeHtml(ideaTitle)}" to a team member</p>
                        
                        <div style="margin-bottom: 20px;">
                            <label for="assignee" style="display: block; margin-bottom: 5px; font-weight: 600;">Select Team Member:</label>
                            <select id="assignee" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">-- Select a team member --</option>
                                ${memberOptions}
                            </select>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="closeAssignmentModal()" style="padding: 8px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                            <button onclick="assignIdea(${ideaId})" style="padding: 8px 20px; background: #4a90e2; color: white; border: none; border-radius: 4px; cursor: pointer;">Assign</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        });
    };
    
    // Close assignment modal
    window.closeAssignmentModal = function() {
        const modal = document.getElementById('assignmentModal');
        if (modal) {
            modal.remove();
        }
    };
    
    // Assign idea to team member
    window.assignIdea = async function(ideaId) {
        const assigneeEmail = document.getElementById('assignee').value;
        if (!assigneeEmail) {
            alert('Please select a team member');
            return;
        }
        
        try {
            const response = await fetch(`/api/ideas/${ideaId}/assign`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ assignee_email: assigneeEmail })
            });
            
            const data = await response.json();
            if (data.success) {
                alert(data.message);
                closeAssignmentModal();
                loadMyIdeas();  // Refresh
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            console.error('Error assigning idea:', error);
            alert('Failed to assign idea');
        }
    };
    
    // Fetch team members for assignment
    async function fetchTeamMembers() {
        const managedTeamId = {{ session.get('user_managed_team_id', 'null') }};
        if (!managedTeamId) {
            return [];
        }
        
        try {
            const response = await fetch(`/api/teams/${managedTeamId}/members`);
            if (response.ok) {
                return await response.json();
            }
            return [];
        } catch (error) {
            console.error('Error fetching team members:', error);
            return [];
        }
    }
    
    // Auto-refresh every 30 seconds
    setInterval(() => {
        loadMyIdeas();
    }, 30000);
})();
</script>
{% endblock %}